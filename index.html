<!doctype html>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>AudioMoth Chime (Mergin link)</title>
<style>
  body{font:16px system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;max-width:700px;margin:16px auto;padding:0 12px}
  label{display:block;margin:10px 0 4px} input{width:100%;padding:8px}
  button{padding:10px 14px;margin-top:14px}
  .row{display:flex;gap:12px;flex-wrap:wrap}
  .hint{opacity:.8;margin-top:10px;min-height:1.2em}
</style>

<!-- AudioMoth chime library files (keep these filenames exactly) -->
<script src="./AudioMothChime.js"></script>
<script src="./AudioMothChimeConnector.js"></script>

<h1>AudioMoth Chime</h1>
<p>Prefilled from the Mergin link. Adjust if needed, then press Play.</p>

<label>Latitude</label><input id="lat" type="text" inputmode="decimal" placeholder="56.949600">
<label>Longitude</label><input id="lon" type="text" inputmode="decimal" placeholder="24.105200">
<label>Deployment (decimal or 0xHEX; fits in 8 bytes)</label><input id="dep" type="text" inputmode="numeric" placeholder="e.g. 12345 or 0x0000000000003039">

<div class="row">
  <button id="test">Test audio (1 kHz / 1 s)</button>
  <button id="play">Play chime</button>
</div>
<div class="hint" id="status"></div>

<script>
  // ---------- DOM helpers ----------
  const $ = (id) => document.getElementById(id);
  const latEl = $('lat');
  const lonEl = $('lon');
  const depEl = $('dep');
  const statusEl = $('status');
  function setStatus(msg){ statusEl.textContent = msg || ''; }

  // ---------- Query string prefill ----------
  const qs = new URLSearchParams(location.search);
  const lat0 = qs.get('lat') ?? qs.get('latitude');
  const lon0 = qs.get('lon') ?? qs.get('lng') ?? qs.get('longitude');
  const dep0 = qs.get('deployment') ?? qs.get('dep') ?? qs.get('deployment_id');

  // Accept commas but always display with a dot and 6 decimals
  function toFixed6Dot(v){
    const n = Number(String(v ?? '').trim().replace(',', '.'));
    return Number.isFinite(n) ? n.toFixed(6) : '';
  }
  if (lat0 != null) latEl.value = toFixed6Dot(lat0);
  if (lon0 != null) lonEl.value = toFixed6Dot(lon0);
  if (dep0) depEl.value = dep0;

  // Keep the parser tolerant to commas, but normalize on blur/change
  function parseNumberLike(inputEl){
    const raw = (inputEl.value || '').trim().replace(',', '.');
    const n = Number(raw);
    return Number.isFinite(n) ? n : NaN;
  }
  ['blur','change'].forEach(ev => {
    latEl.addEventListener(ev, () => { const n = parseNumberLike(latEl); if (Number.isFinite(n)) latEl.value = n.toFixed(6); });
    lonEl.addEventListener(ev, () => { const n = parseNumberLike(lonEl); if (Number.isFinite(n)) lonEl.value = n.toFixed(6); });
  });

  // ---------- Deployment helpers (decimal or 0xHEX -> 8 bytes) ----------
  function bigIntTo8Bytes(x){
    let n = BigInt(x);
    const out = Array(8).fill(0);
    for (let i = 7; i >= 0; i--) { out[i] = Number(n & 0xFFn); n >>= 8n; }
    return out;
  }
  function parseDeployment(s){
    if (!s) return null;
    s = s.trim();
    if (/^0x[0-9a-f]+$/i.test(s)) return bigIntTo8Bytes(BigInt(s)); // hex
    if (/^[0-9]+$/.test(s))       return bigIntTo8Bytes(s);         // decimal
    return null;
  }

  // ---------- Test audio (plain beep) ----------
  $('test').addEventListener('click', async () => {
    try{
      const AC = window.AudioContext || window.webkitAudioContext;
      const ctx = new AC();
      const osc = ctx.createOscillator();
      osc.frequency.value = 1000; // 1 kHz, very audible
      osc.connect(ctx.destination);
      osc.start();
      setStatus('Beep playing…');
      setTimeout(() => { osc.stop(); ctx.close(); setStatus('Beep finished.'); }, 1000);
    }catch(e){
      console.error(e);
      setStatus('Could not play test tone: ' + e.message);
    }
  });

  // ---------- Chime playback ----------
  let connector;
  try{
    connector = new AudioMothChimeConnector();
  }catch(e){
    console.error(e);
    setStatus('AudioMoth scripts not loaded. Check that AudioMothChime.js and AudioMothChimeConnector.js are present in the repo root.');
  }

  $('play').addEventListener('click', async () => {
    if (!connector){
      setStatus('Chime library not available.');
      return;
    }
    try{
      // Resume audio context if needed (mobile browsers)
      if (connector.audioContext && connector.audioContext.state === 'suspended'){
        await connector.audioContext.resume();
      }

      const latNum = parseNumberLike(latEl);
      const lonNum = parseNumberLike(lonEl);
      const depArr = parseDeployment(depEl.value);
      const hasLatLon = Number.isFinite(latNum) && Number.isFinite(lonNum);

      setStatus('Playing chime… ensure device volume is up / not muted.');
      const done = () => setStatus('Chime finished.');
      const now = new Date();

      if (depArr) {
        // NOTE: order = (date, latitude, longitude, deploymentID, callback)
        connector.playTimeAndDeploymentID(now, hasLatLon ? latNum : null, hasLatLon ? lonNum : null, depArr, done);
      } else {
        connector.playTime(now, hasLatLon ? latNum : null, hasLatLon ? lonNum : null, done);
      }
    }catch(e){
      console.error(e);
      setStatus('Error while playing chime: ' + e.message);
    }
  });
</script>
